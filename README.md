---
title: Deep Q Network(DQN)
date: 2021-12-07
categories: RL
tag: Machine Learning
game: LunarLander-v2(gym)
---
**如今, 随着机器学习在日常生活中的各种应用, 各种机器学习方法也在融汇, 合并, 升级. 而我们今天所要探讨的强化学习则是这么一种融合了神经网络和 Q learning 的方法, 名字叫做 Deep Q Network. 这种新型结构是为什么被提出来呢? 原来, 传统的表格形式的强化学习有这样一个瓶颈。**
<!--more-->
## QLearning
QLearning是强化学习算法中value-based的算法，Q即为Q（s,a）就是在某一时刻的 s 状态下(s∈S)，采取 动作a (a∈A)动作能够获得收益的期望，环境会根据agent的动作反馈相应的回报reward r，所以算法的主要思想就是将State与Action构建成一张Q-table来存储Q值，然后根据Q值来选取能够获得最大的收益的动作。

| Q-Table | a1 | a2 |
| ----: | ----: | ----: |
| s1 | q(s1,a1) | q(s1,a2) |
| s2 | q(s2,a1) | q(s2,a2) |
| s3 | q(s3,a1) | q(s3,a2) |

Qlearning的主要优势就是使用了时间差分法TD（融合了蒙特卡洛和动态规划）能够进行离线学习, 使用bellman方程可以对马尔科夫过程求解最优策略。
Q(s,a)状态动作值函数

![20211207150858](https://cdn.jsdelivr.net/gh/wxt406611016/cdn/image/20211207150858.png)

其中Gt是从t时刻开始的总折扣奖励，从这里我们能看出来 γ衰变值对Q函数的影响，γ越接近于1代表它越有远见会着重考虑后续状态的的价值，当γ接近0的时候就会变得近视只考虑当前的利益的影响。所以从0到1，算法就会越来越会考虑后续回报的影响。

---
## 为什么使用神经网络(为什么提出DQN)
我们使用表格来存储每一个状态 state, 和在这个 state 每个行为 action 所拥有的 Q 值. 而当今问题是在太复杂, 状态可以多到比天上的星星还多(比如下围棋). 如果全用表格来存储它们, 恐怕我们的计算机有再大的内存都不够, 而且每次在这么大的表格中搜索对应的状态也是一件很耗时的事. 不过, 在机器学习中, 有一种方法对这种事情很在行, 那就是神经网络. 我们可以将状态和动作当成神经网络的输入, 然后经过神经网络分析后得到动作的 Q 值, 这样我们就没必要在表格中记录 Q 值, 而是直接使用神经网络生成 Q 值. 还有一种形式的是这样, 我们也能只输入状态值, 输出所有的动作值, 然后按照 Q learning 的原则, 直接选择拥有最大值的动作当做下一步要做的动作. 我们可以想象, 神经网络接受外部的信息, 相当于眼睛鼻子耳朵收集信息, 然后通过大脑加工输出每种动作的值, 最后通过强化学习的方式选择动作.

---
## 如何更新神经网络
接下来我们基于第二种神经网络来分析, 我们知道, 神经网络是要被训练才能预测出准确的值. 那在强化学习中, 神经网络是如何被训练的呢? 首先, 我们需要 a1, a2 正确的Q值, 这个 Q 值我们就用之前在 Q learning 中的 Q 现实来代替. 同样我们还需要一个 Q 估计 来实现神经网络的更新. 所以神经网络的的参数就是老的 NN 参数 加学习率 alpha 乘以 Q 现实 和 Q 估计 的差距. 我们整理一下.

![20211207151445](https://cdn.jsdelivr.net/gh/wxt406611016/cdn/image/20211207151445.png)

我们通过 NN 预测出Q(s2, a1) 和 Q(s2,a2) 的值, 这就是 Q 估计. 然后我们选取 Q 估计中最大值的动作来换取环境中的奖励 reward. 而 Q 现实中也包含从神经网络分析出来的两个 Q 估计值, 不过这个 Q 估计是针对于下一步在 s' 的估计. 最后再通过刚刚所说的算法更新神经网络中的参数.

---
## DQN在LunarLander-v2上的应用
未训练前：

![image](https://cdn.jsdelivr.net/gh/wxt406611016/cdn@master/vedio/20211209-103248.gif)

对应的奖励如下所示，可以看到毫无policy可言，效果一塌糊涂：
```
reward_sum:-153.79
reward_sum:-119.95
reward_sum:-126.0
reward_sum:-137.3
```

训练后:

![image](https://cdn.jsdelivr.net/gh/wxt406611016/cdn@master/vedio/20211209-104435.gif)

```
reward_sum:253.87
reward_sum:232.45
reward_sum:277.11
reward_sum:291.65
```
训练后效果得到明显提升。

---
## 代码说明：
依赖环境：
```
torch==1.9.0
gym==0.21.0
swig（通过conda安装）
box2d-py==2.3.8
##如果不安装swig和box2d-py会报错无法加载LunarLander-v2
```
* main.ipynb：用于训练模型使得模型学习如何选择动作，训练完成后会在当前目录生成dqn.eval_v3.pth模型文件
* test.ipynb：用于测试模型学习如何选择动作的效果
* dqn_agent.py, model.py : test.ipynb需要导入这两个文件
* ps：
  * 上述文件中env.render()被注释掉了，因为在jupyter环境下无法正常使用，env.render()用于渲染动画效果，能够实时显示动画，若想使用可以保存代码到本地py文件运行，并将注释取消即可。
